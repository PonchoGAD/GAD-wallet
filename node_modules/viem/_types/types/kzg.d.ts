// src/wallet/core/services/send.ts
import { createWalletClient, http, type Address } from 'viem';
import { privateKeyToAccount } from 'viem/accounts';
import { bsc } from 'viem/chains';
import { ERC20_ABI } from './abi';
import { publicClient } from './bscClient';

const RPC =
  process.env.NEXT_PUBLIC_BSC_RPC_URL || 'https://bsc-dataseed.binance.org';

// ‚úÖ —Å–æ–∑–¥–∞—ë–º –∫–æ—à–µ–ª—ë–∫ —Å —è–≤–Ω—ã–º chain: bsc
function makeWallet(privKey: `0x${string}`) {
  const account = privateKeyToAccount(privKey);
  const wallet = createWalletClient({
    chain: bsc,
    transport: http(RPC),
    account,
  });
  return { wallet, account };
}

// üîπ –û—Ç–ø—Ä–∞–≤–∫–∞ BNB
export async function sendNative(
  privKey: `0x${string}`,
  to: Address,
  amountWei: string | bigint
) {
  const { wallet, account } = makeWallet(privKey);
  const value = typeof amountWei === 'string' ? BigInt(amountWei) : amountWei;

  // ‚úÖ –¥–æ–±–∞–≤–ª—è–µ–º chain: bsc (–∏–Ω–∞—á–µ TS –∂–¥—ë—Ç kzg)
  const hash = await wallet.sendTransaction({
    account,
    to,
    value,
    chain: bsc,
  });

  await publicClient.waitForTransactionReceipt({ hash });
  return hash;
}

// üîπ –û—Ç–ø—Ä–∞–≤–∫–∞ ERC20
export async function sendERC20(
  privKey: `0x${string}`,
  token: Address,
  to: Address,
  amountWei: bigint
) {
  const { wallet, account } = makeWallet(privKey);

  // ‚úÖ chain: bsc –Ω—É–∂–Ω–æ –∏ –∑–¥–µ—Å—å
  const txHash = await wallet.writeContract({
    address: token,
    abi: ERC20_ABI,
    functionName: 'transfer',
    args: [to, amountWei],
    account,
    chain: bsc,
  });

  await publicClient.waitForTransactionReceipt({ hash: txHash });
  return txHash;
}
